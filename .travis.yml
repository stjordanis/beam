language: cpp

git:
  depth: false

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-7
      - libboost-all-dev
      - libssl-dev
      - curl
before_install:
  - export TZ=Etc/GMT-3
  - eval "CC=gcc-7 && CXX=g++-7"
  - wget https://cmake.org/files/v3.12/cmake-3.12.0-Linux-x86_64.sh -q
  - sudo sh cmake-3.12.0-Linux-x86_64.sh --skip-license --prefix=/usr
  - wget -O cuda-repo-ubuntu1404-10-0-local-10.0.130-410.48_1.0-1_amd64.deb https://developer.nvidia.com/compute/cuda/10.0/Prod/local_installers/cuda-repo-ubuntu1404-10-0-local-10.0.130-410.48_1.0-1_amd64 -q
  - sudo dpkg -i cuda-repo-ubuntu1404-10-0-local-10.0.130-410.48_1.0-1_amd64.deb
  - sudo apt-key add /var/cuda-repo-10-0-local-10.0.130-410.48/7fa2af80.pub  
  - sudo apt-get update
  - sudo apt-get install cuda
env: BUILD_TYPE=Release OS_FOLDER=linux

script:
  - cmake -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DDEBUG_MESSAGES_IN_RELEASE_MODE=On -DBEAM_LINK_TYPE=Static -DBRANCH_NAME=$TRAVIS_BRANCH -DBEAM_NO_QT_UI_WALLET=On -DBEAM_USE_GPU=On . && make equihash_test -j4;

# TODO: version detection should be in one place
before_script:
  - BEAM_VERSION="1.0.$(git rev-list HEAD --count)"

after_success:
  # deploy using ftp server
  - BUILDS_SERVER_PATH=${BUILD_SERVER}/files/$TRAVIS_BRANCH/$(date +%Y.%m.%d)/$BUILD_TYPE/$OS_FOLDER
  - tar -cvzf beam-node-gpu-$BEAM_VERSION.tar.gz --directory=$HOME/build/BeamMW/beam/beam beam-node beam-node.cfg
  - curl --retry 3 --ftp-create-dirs -T beam-node-gpu-$BEAM_VERSION.tar.gz $BUILDS_SERVER_PATH/

notifications:
  email:
    - big.romanov@gmail.com
